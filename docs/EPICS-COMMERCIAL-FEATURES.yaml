# EPICS: Commercial Features v1.0
# Pipeline Buddy CRM - Estrutura de Desenvolvimento

epics:
  - epic_id: "EPIC-CF-1"
    title: "Pipeline Forecasting & Probabilidade de Fechamento"
    description: |
      Implementar sistema de scoring de probabilidade em tempo real para cada lead,
      com dashboard executivo para prever receita e acompanhar velocity do pipeline.

    prd_reference: "docs/PRD-COMMERCIAL-FEATURES-V1.md#-feature-1-pipeline-forecasting"
    business_value: |
      - Revenue Accuracy: MAPE < 15% (vs 25-40% atual)
      - Previsibilidade: Manager consegue prever receita com confian√ßa
      - Prioritization: Vendedor sabe quais leads focar
      - Impact: +15-20% revenue via better prioritization

    success_metrics:
      - metric: "Forecast Accuracy (MAPE)"
        target: "< 15%"
        measurement: "Diferen√ßa % entre probabilidade_final e 1.0 para vendas fechadas"

      - metric: "Dashboard Load Time"
        target: "< 2 segundos"
        measurement: "Performance timeline do carregamento"

      - metric: "User Adoption"
        target: ">= 80%"
        measurement: "% de vendedores usando forecasting diariamente"

    scope:
      in:
        - C√°lculo autom√°tico de probabilidade por lead
        - Dashboard de forecasting executivo
        - Integra√ß√£o no kanban (mostrar probabilidade em cards)
        - Hist√≥rico de probabilidades (forecasting_history table)
        - Alertas (leads 30+ dias em etapa)
        - Relat√≥rio de accuracy (hist√≥rico vs real)
        - Triggers autom√°ticos para rec√°lculo

      out:
        - Integra√ß√£o com sistemas externos (Salesforce, HubSpot)
        - ML/AI modelo treinado (regras simples por enquanto)
        - Mobile app nativo
        - Notifica√ß√µes em tempo real (apenas logs)

    dependencies:
      - "Database schema + migrations (Wave 1)"
      - "RLS policies setup (Wave 1)"

    stories:
      - story_id: "1.1"
        title: "Schema de Forecasting: Nova tabela forecasting_history + coluna probabilidade"
        description: |
          Criar estrutura de dados para armazenar hist√≥rico de probabilidades
          e adicionar coluna probabilidade na tabela cards.

        acceptance_criteria:
          - "‚úÖ Tabela forecasting_history criada com campos: id, card_id, data_snapshot, probabilidade, valor_provavel, receita_real"
          - "‚úÖ UNIQUE constraint em (card_id, data_snapshot)"
          - "‚úÖ Coluna probabilidade adicionada em cards"
          - "‚úÖ √çndices de performance criados"
          - "‚úÖ Migration pronta para deploy"

        complexity: "story_points: 5"
        type: "database"
        assignee: "@data-engineer"

      - story_id: "1.2"
        title: "Stored Procedure: calculate_probability(card_id)"
        description: |
          Implementar fun√ß√£o PL/pgSQL que calcula probabilidade de fechamento
          baseado em: etapa base, tempo na etapa, hist√≥rico, origem, tamanho deal.

        acceptance_criteria:
          - "‚úÖ Fun√ß√£o calcula base_etapa corretamente"
          - "‚úÖ Ajuste de tempo (-2% a cada 10 dias, m√°x -30%)"
          - "‚úÖ Ajuste de hist√≥rico (velocidade movimento +10%)"
          - "‚úÖ Ajuste de origem (refer√™ncia +20%, web -5%)"
          - "‚úÖ Ajuste de tamanho (<20k -5%, >100k +5%)"
          - "‚úÖ Resultado clampado entre 0-100"
          - "‚úÖ Testes com data hist√≥rica (5 cen√°rios)"

        complexity: "story_points: 8"
        type: "backend"
        assignee: "@data-engineer"

      - story_id: "1.3"
        title: "Triggers: Recalcular probabilidade quando lead muda etapa"
        description: |
          Criar triggers para executar calculate_probability quando:
          - card.etapa muda
          - Nightly job (recalc com 24h+ sem update)
          - Lead fechado (calcular accuracy)

        acceptance_criteria:
          - "‚úÖ Trigger AFTER UPDATE cards SET etapa executa"
          - "‚úÖ Nightly job (cron, 02:00 UTC) recalcula leads antigos"
          - "‚úÖ Ao fechar venda, receita_real registrada em forecasting_history"
          - "‚úÖ Sem race conditions (leads simult√¢neos)"
          - "‚úÖ Performance: trigger < 100ms por update"

        complexity: "story_points: 5"
        type: "backend"
        assignee: "@dev"

      - story_id: "1.4"
        title: "Frontend: Integra√ß√£o kanban - mostrar probabilidade em cards"
        description: |
          Adicionar probabilidade visual nos KanbanCards:
          - Percentual (72%)
          - Cor (üü¢ > 70%, üü° 40-70%, üî¥ < 40%)
          - Dias na etapa (‚è±Ô∏è 15 dias)

        acceptance_criteria:
          - "‚úÖ Card mostra probabilidade % em verde/amarelo/vermelho"
          - "‚úÖ Hover mostra breakdown (base: 40%, tempo: -10%, origem: +20%)"
          - "‚úÖ Atualiza em tempo real quando lead muda etapa"
          - "‚úÖ Mobile: leg√≠vel (n√£o quebra layout)"
          - "‚úÖ Acessibilidade: contraste > 4.5:1"

        complexity: "story_points: 5"
        type: "frontend"
        assignee: "@dev"

      - story_id: "1.5"
        title: "P√°gina: Forecasting Dashboard"
        description: |
          Nova p√°gina `/forecasting` com KPIs, gr√°ficos, alertas, tabela de leads.

        acceptance_criteria:
          - "‚úÖ 4 KPI cards carregam (Receita Real, Prov√°vel, Accuracy, Prob M√©dia)"
          - "‚úÖ Gr√°fico Real vs Prov√°vel (√∫ltimos 6 meses)"
          - "‚úÖ Alertas vis√≠veis (5+ leads atrasados, funil -20% vs m√™s anterior)"
          - "‚úÖ Tabela com leads filtr√°veis (HIGH, MED, LOW probability)"
          - "‚úÖ Histograma de distribui√ß√£o"
          - "‚úÖ Forecast 3 meses"
          - "‚úÖ Mobile responsivo"
          - "‚úÖ Performance < 2s"

        complexity: "story_points: 13"
        type: "frontend"
        assignee: "@dev"

      - story_id: "1.6"
        title: "Relat√≥rio: Accuracy & Pipeline Velocity"
        description: |
          Novo relat√≥rio mostrando MAPE (forecast accuracy) e velocity por etapa.

        acceptance_criteria:
          - "‚úÖ Tabela: Leads que fecharam (6 meses) com prob_final vs real"
          - "‚úÖ MAPE calculado corretamente"
          - "‚úÖ Gr√°fico: Tempo m√©dio por etapa (histograma)"
          - "‚úÖ Alerta se etapa X > 20% mais lenta que hist√≥rico"
          - "‚úÖ Export√°vel como CSV"

        complexity: "story_points: 8"
        type: "frontend"
        assignee: "@dev"

    timeline:
      wave: 2
      duration_weeks: 4
      start_date: "2025-03-03"
      end_date: "2025-03-31"

  - epic_id: "EPIC-CF-2"
    title: "Atribui√ß√£o de Leads + Distribui√ß√£o Autom√°tica"
    description: |
      Sistema para atribuir leads a vendedores com 3 modos: Manual, Round-Robin, Smart.
      Inclui notifica√ß√µes, filtros por vendedor, relat√≥rios de performance individual.

    prd_reference: "docs/PRD-COMMERCIAL-FEATURES-V1.md#-feature-2-atribui√ß√£o-de-leads"
    business_value: |
      - Escalabilidade: Equipe cresce 5x (distribui√ß√£o autom√°tica vs manual)
      - Onboarding: Novo vendedor produtivo no 1¬∫ dia (recebe leads automaticamente)
      - Fairness: Carga de trabalho equilibrada (smart distribution)
      - Impact: -40% tempo administrativo

    success_metrics:
      - metric: "Lead Assignment Time"
        target: "< 2 minutos para 50 leads"
        measurement: "Cron√¥metro em assignment page"

      - metric: "Workload Balance"
        target: "Desvio padr√£o de leads < 20%"
        measurement: "StDev de leads_count por vendedor"

      - metric: "Onboarding Time"
        target: "-50% (2h ‚Üí 1h)"
        measurement: "Tempo para novo vendedor ter 10 leads qualificados"

    scope:
      in:
        - Campo vendedor_id em leads table
        - 3 modos de distribui√ß√£o (manual, round-robin, smart)
        - P√°gina /leads/assignment (UI para atribuir)
        - Filtro "Meus Leads" no Kanban
        - Notifica√ß√µes "Novo lead atribu√≠do"
        - Hist√≥rico de atribui√ß√µes (assignment_history table)
        - Relat√≥rios por vendedor (convers√£o, tempo m√©dio, pipeline)

      out:
        - Atribui√ß√£o por scorecard/AI (future feature)
        - Reassignments autom√°ticas (j√° foi com n√£o responde)
        - Integra√ß√£o com CRM externo

    dependencies:
      - "EPIC-CF-1 (forecasting) ‚Äî para smart distribution score"
      - "Notification system setup"
      - "Auth + roles (manager, vendedor, admin)"

    stories:
      - story_id: "2.1"
        title: "Schema: Campo vendedor_id em leads + assignment_history table"
        description: |
          Adicionar FK vendedor_id em leads e criar tabela de auditoria.

        acceptance_criteria:
          - "‚úÖ Coluna vendedor_id adicionada em leads (FK para auth.users)"
          - "‚úÖ Coluna atribuido_em adicionada"
          - "‚úÖ assignment_history table criada com: id, lead_id, vendedor_anterior, vendedor_novo, motivo, atribuido_por, criado_em"
          - "‚úÖ √çndices de performance criados"
          - "‚úÖ Migration pronta"

        complexity: "story_points: 3"
        type: "database"
        assignee: "@data-engineer"

      - story_id: "2.2"
        title: "Backend: Fun√ß√µes de distribui√ß√£o (round-robin, smart)"
        description: |
          Implementar stored procedures para calcular pr√≥ximo vendedor.

        acceptance_criteria:
          - "‚úÖ Fun√ß√£o next_in_rotation() retorna pr√≥ximo vendedor (round-robin)"
          - "‚úÖ Fun√ß√£o calc_best_vendor_for_assignment() implementa smart logic"
          - "‚úÖ Sem erros quando n√£o h√° vendedores ativos"
          - "‚úÖ Testes: distribuir 100 leads ‚Üí verificar balance"
          - "‚úÖ Performance < 50ms por distribui√ß√£o"

        complexity: "story_points: 8"
        type: "backend"
        assignee: "@data-engineer"

      - story_id: "2.3"
        title: "Frontend: P√°gina /leads/assignment"
        description: |
          Interface para visualizar vendedores, leads n√£o atribu√≠dos, e realizar atribui√ß√£o.

        acceptance_criteria:
          - "‚úÖ Coluna esquerda: Lista de vendedores (nome, leads_count, performance, pipeline)"
          - "‚úÖ Coluna direita: Leads n√£o atribu√≠dos (tabela com nome, valor, a√ß√µes)"
          - "‚úÖ Dropdown para atribuir lead a vendedor espec√≠fico"
          - "‚úÖ Bot√£o [üîÑ Auto-Distribuir] com modal (modo: round-robin/smart)"
          - "‚úÖ Confirma√ß√£o antes de distribuir"
          - "‚úÖ Feedback visual (X leads distribu√≠dos em Ys)"
          - "‚úÖ Mobile responsivo"
          - "‚úÖ Performance < 2s"

        complexity: "story_points: 13"
        type: "frontend"
        assignee: "@dev"

      - story_id: "2.4"
        title: "Frontend: Filtro 'Meus Leads' no Kanban"
        description: |
          Adicionar checkbox no LeadFilter para mostrar apenas leads do vendedor logado.

        acceptance_criteria:
          - "‚úÖ Checkbox [üë§ Meus Leads] no filtro"
          - "‚úÖ Quando ativado, kanban mostra apenas cards onde lead.vendedor_id == current_user.id"
          - "‚úÖ Filtro persiste em localStorage"
          - "‚úÖ Atualiza em tempo real quando novo lead atribu√≠do"

        complexity: "story_points: 3"
        type: "frontend"
        assignee: "@dev"

      - story_id: "2.5"
        title: "Notifica√ß√µes: Sistema de alertas para novo lead atribu√≠do"
        description: |
          Criar tabela notifications + trigger para notificar vendedor quando lead atribu√≠do.

        acceptance_criteria:
          - "‚úÖ Tabela notifications criada"
          - "‚úÖ Trigger: AFTER UPDATE leads SET vendedor_id ‚Üí criar notification"
          - "‚úÖ Toast aparece em tempo real (se online)"
          - "‚úÖ Email enviado (template)"
          - "‚úÖ Notifica√ß√£o marca como lida quando clicada"
          - "‚úÖ Hist√≥rico de notifica√ß√µes acess√≠vel"

        complexity: "story_points: 8"
        type: "backend"
        assignee: "@dev"

      - story_id: "2.6"
        title: "Relat√≥rios: Performance por Vendedor"
        description: |
          Nova p√°gina `/relatorios/vendedores` com cards individuais.

        acceptance_criteria:
          - "‚úÖ Card por vendedor: nome, leads_count, taxa_convers√£o, valor_m√©dio, tempo_m√©dio, pipeline_total, vendas_fechadas_m√™s"
          - "‚úÖ Gr√°fico: Leads por etapa (este vendedor)"
          - "‚úÖ Gr√°fico: Performance vs M√©dia da Equipe"
          - "‚úÖ Per√≠odo selecion√°vel (m√™s, trimestre, ano)"
          - "‚úÖ Export√°vel como CSV"
          - "‚úÖ Mobile responsivo"

        complexity: "story_points: 10"
        type: "frontend"
        assignee: "@dev"

    timeline:
      wave: 2
      duration_weeks: 4
      start_date: "2025-03-03"
      end_date: "2025-03-31"

  - epic_id: "EPIC-CF-3"
    title: "Hist√≥rico de Negocia√ß√£o + Sistema de Notas"
    description: |
      Sistema unificado de notas/anota√ß√µes com 3 n√≠veis de visibilidade (p√∫blica, privada, interna),
      timeline visual, @mentions, tags, anexos, busca e exporta√ß√£o de hist√≥rico.

    prd_reference: "docs/PRD-COMMERCIAL-FEATURES-V1.md#-feature-3-hist√≥rico-de-negocia√ß√£o"
    business_value: |
      - Context Sharing: Handoff 100% mais r√°pido (contexto completo acess√≠vel)
      - Compliance: Auditoria completa (quem falou o qu√™ e quando)
      - Knowledge Sharing: Equipe aprende com hist√≥rico de negocia√ß√µes bem-sucedidas
      - Impact: -30% tempo de onboarding, +20% deal retention

    success_metrics:
      - metric: "Handoff Success Rate"
        target: ">= 90%"
        measurement: "% de vendas que n√£o perdida ap√≥s handoff"

      - metric: "Notes per Lead"
        target: ">= 3 notas"
        measurement: "M√©dia de anota√ß√µes por lead no pipeline"

      - metric: "Team Knowledge Base"
        target: ">= 80% leads com hist√≥rico"
        measurement: "% de leads com >= 2 notas p√∫blicas"

    scope:
      in:
        - Tabela anotacoes com 3 tipos (p√∫blica, privada, interna)
        - Rich editor com markdown + @mentions
        - Timeline visual (sidebar no kanban)
        - Tags para categorizar (#desconto, #follow-up, #urgente)
        - Anexos (files + URLs)
        - RLS policies (quem v√™ o qu√™)
        - Busca no hist√≥rico
        - Exporta√ß√£o para PDF
        - Notifica√ß√µes de @mentions

      out:
        - AI summarization de notas
        - Integra√ß√£o com email/Slack
        - Voice recording integrado

    dependencies:
      - "Rich text editor library (prosemirror ou slate)"
      - "S3/Storage para attachments (se n√£o for s√≥ links)"
      - "RLS policies validation"

    stories:
      - story_id: "3.1"
        title: "Schema: Tabelas anotacoes, anotacao_mentions, anotacao_anexos, anotacao_tags"
        description: |
          Criar estrutura para armazenar notas com relacionamentos.

        acceptance_criteria:
          - "‚úÖ Tabela anotacoes: id, lead_id, autor_id, tipo (enum), conteudo, conteudo_html, criado_em, atualizado_em, deleted_at"
          - "‚úÖ Tabela anotacao_mentions: id, anotacao_id, usuario_mencionado_id"
          - "‚úÖ Tabela anotacao_anexos: id, anotacao_id, tipo (file/link), url, nome_arquivo, tamanho_bytes"
          - "‚úÖ Tabela anotacao_tags: id, anotacao_id, tag"
          - "‚úÖ √çndices de performance"
          - "‚úÖ Soft delete support (deleted_at)"
          - "‚úÖ Migration pronta"

        complexity: "story_points: 5"
        type: "database"
        assignee: "@data-engineer"

      - story_id: "3.2"
        title: "RLS Policies: Controle de acesso para anotacoes"
        description: |
          Implementar policies: p√∫blica (todos), privada (autor+manager), interna (manager).

        acceptance_criteria:
          - "‚úÖ Policy SELECT: tipo='p√∫blica' ‚Üí todos veem"
          - "‚úÖ Policy SELECT: tipo='privada' ‚Üí autor + manager veem"
          - "‚úÖ Policy SELECT: tipo='interna' ‚Üí manager s√≥"
          - "‚úÖ Policy INSERT: s√≥ autor pode criar"
          - "‚úÖ Policy DELETE: autor ou manager"
          - "‚úÖ Testes com 3 usu√°rios (vendedor, manager, admin)"
          - "‚úÖ Sem data leaks"

        complexity: "story_points: 8"
        type: "backend"
        assignee: "@architect"

      - story_id: "3.3"
        title: "Frontend: Rich Editor + Modal de Criar Nota"
        description: |
          Componente para escrever notas com markdown, @mentions, tags, anexos.

        acceptance_criteria:
          - "‚úÖ Modal com 3 campos: Tipo (dropdown), Conte√∫do (rich editor), Cc (@mentions)"
          - "‚úÖ Markdown preview (live)"
          - "‚úÖ Autocomplete para @mentions (lista de usu√°rios)"
          - "‚úÖ Tags com autocomplete"
          - "‚úÖ Bot√£o [üìé Anexar arquivo] (drag-drop ou file picker)"
          - "‚úÖ Bot√£o [üîó Anexar link]"
          - "‚úÖ Valida√ß√£o: conte√∫do n√£o vazio"
          - "‚úÖ Mobile responsivo"

        complexity: "story_points: 13"
        type: "frontend"
        assignee: "@dev"

      - story_id: "3.4"
        title: "Frontend: Timeline de Hist√≥rico (sidebar)"
        description: |
          Componente NotesSidebar mostrando hist√≥rico cronol√≥gico do lead.

        acceptance_criteria:
          - "‚úÖ Timeline visual (data, hora, autor, tipo de evento)"
          - "‚úÖ Mostra: notas (p√∫blicas/privadas conforme acesso), movimenta√ß√µes, eventos do sistema"
          - "‚úÖ Scroll infinito ou pagina√ß√£o"
          - "‚úÖ Filtros: Apenas notas, Apenas movimenta√ß√µes, Data range"
          - "‚úÖ Performance: carrega primeiras 50 itens < 500ms"
          - "‚úÖ Mobile: timeline scrollable verticalmente"

        complexity: "story_points: 10"
        type: "frontend"
        assignee: "@dev"

      - story_id: "3.5"
        title: "Backend: Busca em anotacoes (full-text search)"
        description: |
          Implementar fun√ß√£o de busca em conte√∫do de notas.

        acceptance_criteria:
          - "‚úÖ Fun√ß√£o search_anotacoes(lead_id, query) retorna matches ordenados por relev√¢ncia"
          - "‚úÖ Busca em conteudo_html (renderizado)"
          - "‚úÖ Respeita RLS (n√£o retorna notas que user n√£o pode ver)"
          - "‚úÖ Performance < 200ms para 500 notas"
          - "‚úÖ Testes: buscar 'cliente', 'desconto', 'follow-up'"

        complexity: "story_points: 5"
        type: "backend"
        assignee: "@data-engineer"

      - story_id: "3.6"
        title: "Notifica√ß√µes: @mentions alertam usu√°rios"
        description: |
          Trigger para notificar quando algu√©m menciona voc√™ (@seu_nome).

        acceptance_criteria:
          - "‚úÖ Trigger: AFTER INSERT anotacoes_mentions ‚Üí notifica√ß√£o criada"
          - "‚úÖ Toast em tempo real (se online)"
          - "‚úÖ Email enviado (template com contexto)"
          - "‚úÖ Link para ir direto na nota"
          - "‚úÖ Notifica√ß√£o marca como lida quando clicada"

        complexity: "story_points: 5"
        type: "backend"
        assignee: "@dev"

      - story_id: "3.7"
        title: "Exporta√ß√£o: Gerar PDF de hist√≥rico completo"
        description: |
          Bot√£o que exporta hist√≥rico do lead para PDF (incluindo timeline, excluindo notas internas).

        acceptance_criteria:
          - "‚úÖ Bot√£o [üì• Exportar Hist√≥rico] no sidebar"
          - "‚úÖ PDF com: cabe√ßalho (lead, per√≠odo), timeline, footer (data de export)"
          - "‚úÖ Inclui notas p√∫blicas + movimenta√ß√µes"
          - "‚úÖ Exclui notas privadas/internas"
          - "‚úÖ Formata√ß√£o leg√≠vel (fonte, spacing)"
          - "‚úÖ Mobile: gera PDF v√°lido"
          - "‚úÖ Performance < 2s para 100 eventos"

        complexity: "story_points: 8"
        type: "frontend"
        assignee: "@dev"

    timeline:
      wave: 3
      duration_weeks: 3
      start_date: "2025-04-01"
      end_date: "2025-04-21"

# Infrastructure & Setup Epic
setup_epic:
  epic_id: "EPIC-CF-0"
  title: "Setup: Infrastructure & Foundation"
  description: |
    Tasks de infraestrutura compartilhadas por todas as features:
    - Database migrations, triggers, indexes
    - Auth + RLS policies
    - Notification system
    - Monitoring + error tracking

  stories:
    - story_id: "0.1"
      title: "Database: Criar migrations master + indexing strategy"
      complexity: "story_points: 8"
      type: "database"
      assignee: "@data-engineer"

    - story_id: "0.2"
      title: "Auth: Validar roles + RLS policies base"
      complexity: "story_points: 5"
      type: "backend"
      assignee: "@architect"

    - story_id: "0.3"
      title: "Notifications: Setup sistema (toast + email)"
      complexity: "story_points: 13"
      type: "backend"
      assignee: "@dev"

    - story_id: "0.4"
      title: "Monitoring: Setup Sentry + error tracking"
      complexity: "story_points: 5"
      type: "devops"
      assignee: "@devops"

  timeline:
    wave: 1
    duration_weeks: 2
    start_date: "2025-02-24"
    end_date: "2025-03-03"

# Execution Plan
execution_plan:
  approach: "Wave-based parallel development"
  waves:
    - wave_num: 1
      name: "Foundation"
      duration_weeks: 2
      epics: ["EPIC-CF-0"]
      parallel_tracks: 1
      start_date: "2025-02-24"

    - wave_num: 2
      name: "Core Features (Forecasting + Assignment)"
      duration_weeks: 4
      epics: ["EPIC-CF-1", "EPIC-CF-2"]
      parallel_tracks: 2
      start_date: "2025-03-03"

    - wave_num: 3
      name: "Notes System"
      duration_weeks: 3
      epics: ["EPIC-CF-3"]
      parallel_tracks: 1
      start_date: "2025-04-01"

    - wave_num: 4
      name: "Polish + Launch"
      duration_weeks: 2
      epics: []
      activities:
        - "Mobile optimization"
        - "Accessibility audit"
        - "Performance optimization"
        - "User testing"
        - "Documentation"
      parallel_tracks: 1
      start_date: "2025-04-21"

  total_weeks: 11
  total_story_points: 187
  recommended_team_size: "2-3 devs"

  critical_path:
    1: "EPIC-CF-0 (Foundation) ‚Üí all else depends"
    2: "EPIC-CF-1.2 (calculate_probability SP) ‚Üí EPIC-CF-2.2 (smart distribution)"
    3: "All frontend features paralleliz√°veis ap√≥s backend ready"

status: "DRAFT"
created_date: "2025-02-22"
next_action: "@po *validate-story-draft on this epic structure"
